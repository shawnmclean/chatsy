// Generated by CoffeeScript 1.3.1
(function() {
  var Manager, authService, exports;

  authService = require('./services/authorizeService').AuthorizeService;

  Manager = (function() {

    Manager.name = 'Manager';

    Manager.prototype.users = [];

    Manager.prototype.rooms = [];

    function Manager(io, options) {
      var self;
      this.io = io;
      this.options = options;
      this.authService = this.options.AuthorizeService || authService;
      io = this.io;
      self = this;
      io.configure(function() {
        return io.of("/chat").authorization(function(handshakeData, callback) {
          return self.authService.canJoinServer(handshakeData, callback);
        }).on("connection", function(socket) {
          if (socket.handshake.user == null) {
            throw "user object was not set on handshake during canJoinServer auth call";
          }
          socket.on('joinRoom', function(data) {
            return self.joinRoom(data, this);
          });
          return socket.on('disconnect', function() {
            return self.disconnected(this);
          });
        });
      });
    }

    Manager.prototype.joinRoom = function(data, socket) {
      var self;
      self = this;
      return this.authService.canJoinRoom(socket.handshake, data.roomId, function(canJoin) {
        var room;
        if (canJoin) {
          room = self.rooms.filter(function(el) {
            return el.roomId === data.roomId;
          })[0];
          if (room == null) {
            return self.authService.getRoom(data.roomId, function(room) {
              return self.setupJoinRoom(room, socket);
            });
          } else {
            return self.setupJoinRoom(room, socket);
          }
        }
      });
    };

    Manager.prototype.disconnected = function(socket) {
      var room, _i, _len, _ref, _results;
      _ref = socket.handshake.user.rooms;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        room = _ref[_i];
        room = this.rooms.filter(function(el) {
          return el.roomId === room.roomId;
        })[0];
        _results.push(room.users = room.users.filter(function(el) {
          return el.userId !== socket.handshake.user.userId;
        }));
      }
      return _results;
    };

    Manager.prototype.setupJoinRoom = function(room, socket) {
      socket.handshake.user.rooms.push(room);
      room.users.push(socket.handshake.user);
      this.rooms.push(room);
      return socket.emit("roomJoined", {
        room: room.roomId
      });
    };

    return Manager;

  })();

  exports = module.exports = Manager;

}).call(this);
